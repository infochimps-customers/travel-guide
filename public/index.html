<!DOCTYPE html>
<html>
<head>
<meta name="viewport" content="initial-scale=1.0, user-scalable=no" />

<link href="http://keepstream.com/stylesheets/reset.css" media="screen" rel="stylesheet" type="text/css" />
<link href="stylesheets/style.css" media="screen" rel="stylesheet" type="text/css" />

<script type="text/javascript" src="http://maps.googleapis.com/maps/api/js?sensor=false"></script>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.6.2/jquery.min.js" type="text/javascript"></script>
<script src="javascripts/jquery.autoellipsis-1.0.2.min.js" type="text/javascript"></script>
<script type="text/javascript" src="javascripts/infobubble.js"></script>



<script type="text/javascript">

  var geocoder;
  var map;
  var markers = [];
  var infoBubbles = [];
  var infoWindows = [];
  var contentRows = [];


  $(document).ready(function() {
    //This doesn't work, but it SHOULD limit the text for the popups :X
    //$('.infobubble-content p').ellipsis();     

    initialize();

    $('#sidebar .content-row').click( function() {
      $('#sidebar .content-row').addClass("selected");    
    });    

    // On enter, submit the form
    $("#address").keydown(function (e) {
      if (e.which == 13) {
        codeAddress();
        return false;
      } else {
        return true;
      }
    });
    
    //
    $('#selector').click( function() {
      $('#dropdown').toggle();
    });

  });
  
  function initialize() {
    geocoder = new google.maps.Geocoder();
    var latlng = new google.maps.LatLng(30.26, -97.73);
    var myOptions = {
      zoom: 12,
      center: latlng,
      mapTypeId: google.maps.MapTypeId.ROADMAP
    }
    map = new google.maps.Map($("#map_canvas")[0], myOptions);
    
    //Close all infoBubbles on map click
    google.maps.event.addListener(map, 'click', function() {
      for (var i = 0; i < infoBubbles.length; i++) {  
        infoBubbles[i].close();
      }
    });
   
    //Add markers to the map!     
    $.post('/data', function(data) {
      
      // data['results'].length 
      for (var i = 0; i < data['results'].length; i++) {      
       
        var title = data['results'][i]['title'];
        var description = data['results'][i]['abstract'];       
        if (description.length > 400) { description = data['results'][i]['abstract'].substr(0,400) + '...'; }
        var url = data['results'][i]['url'];        
        addMarker(data['results'][i]['coordinates'][1],data['results'][i]['coordinates'][0],title,'h',description,url);

      }
      
    });
    
  }
  
  
  // Removes the overlays from the map, but keeps them in the array
  function clearOverlays() {
    if (markers) {
      for (i in markers) {
        markers[i].setMap(null);
      }
    }
  }
  

  function codeAddress() {
    var address = document.getElementById("address").value;
    geocoder.geocode( { 'address': address}, function(results, status) {
      if (status == google.maps.GeocoderStatus.OK) {
        map.setCenter(results[0].geometry.location);
        map.setZoom(12);
        
        //requestUrl = "/data?lat=" + results[0].geometry.location.lat() + "&lng=" + results[0].geometry.location.lng();

        $('#sidebar .recommendations').empty();        
        //alert (requestUrl);
        
        clearOverlays();
        
        $.post('/data', { lat: results[0].geometry.location.lat(), lng: results[0].geometry.location.lng() }, function(data) {
          
          for (var i = 0; i < data['results'].length; i++) { 
            var title = data['results'][i]['title'];
            var description = data['results'][i]['abstract'];
            var url = data['results'][i]['url'];            
            addMarker(data['results'][i]['coordinates'][1],data['results'][i]['coordinates'][0],title,'h',description,url);         
          }
        });
        
      } else {
        alert("Geocode was not successful for the following reason: " + status);
      }
    });
  }

  function addMarker(lat,lng,title,type,description,url) {
    var myLatlng = new google.maps.LatLng(lat, lng);

    // change to javascript switch statement    
    if (type == "e") {
      var restaurantsImage = 'images/entertainment.png';
    } else if (type == "h") {
      var restaurantsImage = 'images/historical.png';
    } else if (type == "n") {
      var restaurantsImage = 'images/nightlife.png';
    } else if (type == "o") {
      var restaurantsImage = 'images/outdoor.png';
    } else if (type == "r") {
      var restaurantsImage = 'images/restaurant.png';
    } else if (type == "s") {
      var restaurantsImage = 'images/shopping.png';  
    } else {
     var restaurantsImage = 'images/historical.png';
    }
    
    // Marker
    var marker = new google.maps.Marker({
	    position: myLatlng,
	    title:title,
	    icon: restaurantsImage
    });
    marker.setMap(map);    
    markers.push(marker);  

    // infoWindow
    //infoDescription = '<div class="infobubble-content"><h3>' + title + '</h3><p>' + description + '</p></div><div class="infobubble-footer"><a href="' + url + '" target="_blank">Read more on Wikipedia &raquo;</a></div>';    
    //var infoWindow = new google.maps.InfoWindow({
    //    content: infoDescription
    //});
    //infoWindows.push(infoWindow);

    // infoBubble
    infoDescription = '<div class="infobubble-content"><h3>' + title + '</h3><p>' + description + '</p></div><div class="infobubble-footer"><a href="' + url + '" target="_blank">Read more on Wikipedia &raquo;</a></div>';    
    var infoBubble = new InfoBubble({
      minWidth:420,
      maxWidth:420,
      minHeight:240,
      maxHeight:240,      
      padding: 0,
      backgroundColor: '#ffffff',
      borderRadius: 8,
      arrowSize: 10,
      borderWidth: 1,
      borderColor: '#dddddd',
      arrowPosition: 50,
      shadowStyle: 3,
      arrowColor: '#f4f4f4',
      content: infoDescription
    });  
    infoBubbles.push(infoBubble);

    // Sidebar content  
    var contentRow = '<div class="content-row"><p><strong>' + title + '</strong>' + description + '</p></div>';    
    $(contentRow).appendTo($('#sidebar .recommendations')).children('p').ellipsis().click( function() {
      for (var i = 0; i < infoBubbles.length; i++) {  
        infoBubbles[i].close();
      }      
      if ( $(this).hasClass('selected') ) {
        $(this).removeClass('selected');  
        infoBubble.close();
      } else {
        infoBubble.open(map,marker);
        $('#sidebar .content-row p').removeClass('selected');  
        $(this).addClass('selected');  
      }
    });  
    contentRows.push(contentRow);
    
    google.maps.event.addListener(marker, 'click', function() {
      for (var i = 0; i < infoBubbles.length; i++) {  
        //infoWindows[i].close();
        infoBubbles[i].close();  
      }      
      //infoWindow.open(map,marker);
      infoBubble.open(map, marker);
    });
    
    google.maps.event.addListener(infoBubble, 'closeclick', function () {
      $('#sidebar .content-row p').removeClass("selected");     
    });
    
  }
  
</script>



</head>
<body>

  <div id="header">
    <div style="padding:0px 20px">
      I'm visiting<input id="address" class="input" type="textbox" value="Austin, TX"><span style="display:none">from<input id="from" class="input date" value="8/17/2011"></input>to<input id="to" class="input date" value="8/24/2011"></input></span><input id="submit" type="button" value="Create my travel guide" onclick="codeAddress()">
      
    </div>
  </div>

  <div id="map_canvas"></div>


  <div id="sidebar">
  
    <div class="select-container" style="background:#eeeeee;border-bottom:1px solid #d2d1cb;padding:10px;">
    
      <div id="selector"><span class="text">All recommendations</span><span class="arrow"><img src="http://keepstream.com/images/header/arrow-down.png" style="padding-left:11px;position:relative;top:-1px"/></span></div>
    
      <ul id="dropdown" style="display:none">
        <li class="option entertainment first"><span></span>Entertainment</li>
        <li class="option museums"><span></span>Museums</li>
        <li class="option nightlife"><span></span>Nightlife</li>
        <li class="option outdoors"><span></span>Outdoors</li>        
        <li class="option restaurants"><span></span>Restaurants</li>
        <li class="option shopping last"><span></span>Shopping</li>
      </ul>
    </div>
    <div class="recommendations"></div>
  </div>


</div>


</body>
</html>
